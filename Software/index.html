<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HydroSense Dashboard</title>
  <link rel="stylesheet" type="text/css" href="./css/main.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
  <h1>HydroSense Dashboard</h1>
  <hr />
  <div class="data" id="sensorData">Fetching data...</div>

  <div class="container">
    <div class="gauge-container">
      <div class="indicator" id="turbidityIndicator"></div>
      <div class="gauge-labels">
        <span>0%</span>
        <span>100%</span>
      </div>
      <p>Turbidity: <span id="tdValue">100</span></p>
    </div>

    <div class="ph-scale">
      <input type="range" id="phSlider" min="0" max="14" step="0.1" value="7" disabled>
      <div class="ph-labels">
        <span>0</span>
        <span>7</span>
        <span>14</span>
      </div>
      <p>pH Value: <span id="phValue">7.0</span></p>
    </div>
  </div>

  <div class="charts">
    <div class="chart-container">
      <canvas id="phChart"></canvas>
    </div>
    <hr />
    <div class="chart-container">
      <canvas id="turbidityChart"></canvas>
    </div>
    <hr />
    <div class="chart-container">
      <canvas id="tempChart"></canvas>
    </div>
  </div>

  <div class="ai">
    <div class="ai_text">AI Analysis Verdict</div>
    <hr />
    <div id="aiOutput">Loading AI Prediction...</div>
  </div>

  <button class="refresh-button" onclick="fetchSensorData()">Refresh Data</button>
  <button class="refresh-button" onclick="location.reload()">Refresh Page</button>
  <br />
  <button class="ai_button" onclick="ai_report()">Generate AI Report</button>
  <button class="ai_button" onclick="downloadPDF()">Download Data as PDF</button>

  <script>
    let latestPH = null;
    let latestTemp = null;
    let latestTurbidity = null;

    const vegaIP = "http://192.168.4.1";
    const aiAPI = "http://127.0.0.1:5000/predict";
    const huggingFaceAPI = "https://api-inference.huggingface.co/models/google/gemma-2-2b-it";
    const huggingFaceKey = "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"; 

    const phChartCtx = document.getElementById('phChart').getContext('2d');
    const turbidityChartCtx = document.getElementById('turbidityChart').getContext('2d');
    const tempChartCtx = document.getElementById('tempChart').getContext('2d');

    const phChart = new Chart(phChartCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'pH',
          data: [],
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1,
          fill: false
        }]
      },
      options: {
        scales: {
          x: { 
            type: 'linear',
            title: {
              display: true,
              text: 'Count'
            }
          },
          y: { beginAtZero: true, max: 14 }
        }
      }
    });

    const turbidityChart = new Chart(turbidityChartCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Turbidity',
          data: [],
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 1,
          fill: false
        }]
      },
      options: {
        scales: {
          x: { 
            type: 'linear',
            title: {
              display: true,
              text: 'Count'
            }
          },
          y: { beginAtZero: true, max: 100 }
        }
      }
    });

    const tempChart = new Chart(tempChartCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Temperature',
          data: [],
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1,
          fill: false
        }]
      },
      options: {
        scales: {
          x: { 
            type: 'linear',
            title: {
              display: true,
              text: 'Count'
            }
          },
          y: { beginAtZero: true, max: 35 }
        }
      }
    });

    function updateGauge(value) {
      let angle = (value / 100) * 180 - 90;
      document.getElementById("turbidityIndicator").style.transform = `rotate(${angle}deg)`;
      document.getElementById("tdValue").innerText = value.toFixed(0)
    }

    function updatePHScale(value) {
      document.getElementById("phSlider").value = value;
      document.getElementById("phValue").innerText = value.toFixed(1);
    }

    function updateCharts() {
      const phData = JSON.parse(localStorage.getItem('phData')) || [];
      const turbidityData = JSON.parse(localStorage.getItem('turbidityData')) || [];
      const tempData = JSON.parse(localStorage.getItem('tempData')) || [];
      const timestamps = JSON.parse(localStorage.getItem('timestamps')) || [];

      const sampleCount = phData.length + 1;
      const now = new Date().toLocaleString();

      phData.push({ x: sampleCount, y: latestPH });
      turbidityData.push({ x: sampleCount, y: latestTurbidity });
      tempData.push({ x: sampleCount, y: latestTemp });
      timestamps.push(now);

      localStorage.setItem('phData', JSON.stringify(phData));
      localStorage.setItem('turbidityData', JSON.stringify(turbidityData));
      localStorage.setItem('tempData', JSON.stringify(tempData));
      localStorage.setItem('timestamps', JSON.stringify(timestamps));

      phChart.data.labels = phData.map((_, index) => index + 1);
      phChart.data.datasets[0].data = phData.map(d => d.y);
      phChart.update();

      turbidityChart.data.labels = turbidityData.map((_, index) => index + 1);
      turbidityChart.data.datasets[0].data = turbidityData.map(d => d.y);
      turbidityChart.update();

      tempChart.data.labels = tempData.map((_, index) => index + 1);
      tempChart.data.datasets[0].data = tempData.map(d => d.y);
      tempChart.update();
    }

    async function fetchSensorData() {
      try {
        const response = await fetch(vegaIP);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        console.log("Received Data:", data);

        latestPH = data.pH !== null && data.pH !== undefined ? data.pH : 0;
        latestTurbidity = data.Turbidity !== null && data.Turbidity !== undefined ? data.Turbidity : 0;
        latestTemp = data.Temperature !== null && data.Temperature !== undefined ? data.Temperature : 0;

        document.getElementById("sensorData").innerHTML = `
        <table style="margin: 0 auto; border-collapse: collapse;">
          <tr>
            <th style="border: 1px solid #000; padding: 8px;">Parameter</th>
            <th style="border: 1px solid #000; padding: 8px;">Value</th>
            <th style="border: 1px solid #000; padding: 8px;">Limit</th>
          </tr>
          <tr>
            <td style="border: 1px solid #000; padding: 8px;">pH</td>
            <td style="border: 1px solid #000; padding: 8px;">${latestPH}</td>
            <td style="border: 1px solid #000; padding: 8px;">6-8</td>
          </tr>
          <tr>
            <td style="border: 1px solid #000; padding: 8px;">Turbidity</td>
            <td style="border: 1px solid #000; padding: 8px;">${latestTurbidity}%</td>
            <td style="border: 1px solid #000; padding: 8px;">85-100</td>
          </tr>
          <tr>
            <td style="border: 1px solid #000; padding: 8px;">Temperature</td>
            <td style="border: 1px solid #000; padding: 8px;">${latestTemp}Â°C</td>
            <td style="border: 1px solid #000; padding: 8px;">15-35</td>
          </tr>
        </table>
      `;

        updateGauge(latestTurbidity);
        updatePHScale(latestPH);
        updateCharts();

        // Call fetchAIAnalysis after successfully fetching sensor data
        fetchAIAnalysis();
      } catch (error) {
        console.error("Error:", error);
        document.getElementById("sensorData").innerHTML = "Error fetching data!";
      }
    }

    async function ai_report() {
      try {
        const phData = JSON.parse(localStorage.getItem('phData')) || [];
        const turbidityData = JSON.parse(localStorage.getItem('turbidityData')) || [];
        const tempData = JSON.parse(localStorage.getItem('tempData')) || [];
        const timestamps = JSON.parse(localStorage.getItem('timestamps')) || [];
    
        const historicalData = phData.map((_, index) => ({
          timestamp: timestamps[index],
          pH: phData[index].y,
          turbidity: turbidityData[index].y,
          temperature: tempData[index].y,
        }));
    
        const response = await fetch(huggingFaceAPI, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${huggingFaceKey}`
          },
          body: JSON.stringify({
            inputs: `Analyze the following water quality data and provide a detailed report with characteristics, anomalies, and a final verdict on water quality:\n\n${JSON.stringify(historicalData)}`
          }),
        });
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const report = await response.json();
        console.log("AI Report Output:", report);
    
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
    
        // Set font to Times New Roman and size to 14
        doc.setFont("times", "normal");
        doc.setFontSize(14);
    
        // Add header
        doc.text("HydroSense AI Report", 105, 10, null, null, "center");
        doc.setLineWidth(0.5);
        doc.line(14, 12, 196, 12); // Add a line below the header
    
        // Extract AI response and convert markdown to plain text
        const aiResponse = report[0].generated_text;
        const plainText = aiResponse.replace(/[*_~`]/g, '');
    
        // Add AI response content with margins and text wrapping
        const textLines = doc.splitTextToSize(plainText, 180);
        let y = 26;
        textLines.forEach(line => {
          if (y > 280) { // Check if we need to add a new page
            doc.addPage();
            y = 20; // Reset y position for new page
          }
          doc.text(line, 14, y);
          y += 10; // Increment y position for next line
        });
    
        // Add footer with time generated and model details
        const currentTime = new Date().toLocaleString();
        const modelDetails = "Model: google/gemma-2-2b-it";
        doc.setFontSize(10);
        doc.text(`Generated on: ${currentTime}`, 14, 290);
        doc.text(modelDetails, 14, 295);
    
        // Save the PDF
        doc.save('HydroSense_AI_Report.pdf');
      } catch (error) {
        console.error("Error:", error);
        document.getElementById("aiOutput").innerHTML = "AI report generation error!";
      }
    }

    async function fetchAIAnalysis() {
      try {
        if (latestPH === null || latestTurbidity === null || latestTemp === null) {
          throw new Error("Sensor data is not available");
        }

        const response = await fetch(aiAPI, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pH: latestPH, Turbidity: latestTurbidity, Temperature: latestTemp }),
        });
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        console.log("AI Model Output:", data);
        document.getElementById("aiOutput").innerHTML = `${data.result}`;
      } catch (error) {
        console.error("Error:", error);
        document.getElementById("aiOutput").innerHTML = "AI model error!";
      }
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const phData = JSON.parse(localStorage.getItem('phData')) || [];
      const turbidityData = JSON.parse(localStorage.getItem('turbidityData')) || [];
      const tempData = JSON.parse(localStorage.getItem('tempData')) || [];
      const timestamps = JSON.parse(localStorage.getItem('timestamps')) || [];

      let tableData = [];
      for (let i = 0; i < phData.length; i++) {
        tableData.push([
          i + 1,
          timestamps[i],
          phData[i].y,
          turbidityData[i].y,
          tempData[i].y,
        ]);
      }

      doc.text("HydroSense Data Report", 14, 16);
      doc.line(14, 18, 196, 18); // Add a line below the title
      doc.autoTable({
        margin: { top: 22 }, // Add margin gap after the line
        head: [['Count', 'Timestamp', 'pH', 'Turbidity', 'Temperature']],
        body: tableData,
      });

      doc.save('HydroSense_Data_Report.pdf');
    }

    fetchSensorData();

    // Set up periodic updates every 60 seconds (60000 milliseconds)
    setInterval(() => {
      fetchSensorData();
    }, 60000);
  </script>
</body>

</html>